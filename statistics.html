<!DOCTYPE html>
<html>

<head>
    <link rel="shortcut icon" type="image/x-icon" href="static/favicon.ico">
    <title>Flight statistics</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha384-eS4bw6aEvhCSXWGP85ANR/N8isWKzT7P36NvcuTJGkrj6wsbxLVpXslrNXYHyseD" crossorigin="anonymous">
    <link rel="stylesheet" href="static/flightmap.css">
    <style>
        #map {
            width: 98%;
            min-width: 325px;
            min-height: 285px;
            height: 42%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="statistics" style="min-width:325px;height:430px;padding: 1em;border: 1px"></div>
    <div id="explanation">
        <h3>Usage</h3>
        Click in any FIR/UIR to display the respective development of the number
        of airline flights in the year 2020. You may select multiple airspaces
        at the same time. Clicking a second time on the same airspace deselects
        it. Switching between FIRs and UIRs on the map is done via the legend.
        The view can be toggled between absolute numbers and a percentage
        related to the average number of flights in the first ten days of the
        year.
        <h3>Content</h3>
        Some regions don't discriminate between FIR and UIR or
        have been simplified due to a lack of reliable openly available shape
        files and to save computation power in data processing.
        Aircraft position data was consumed as state vectors from the
        <a href='https://opensky-network.org/apidoc/'>OpenSky Network API</a>
        as well as from the
        <a href='https://opensky-network.org/data/impala'>
            OpenSky Network historical database</a>
        at intervals between 10 seconds and 15 minutes.
        State vectors with incomplete positional information or on_ground state
        were ignored.
        This statistics is focused on airline flights and should ignore general
        aviation. Only callsigns matching the following regular expression have
        been processed:
        <code>^([A-Z]{3})[0-9](([0-9]{0,3})|([0-9]{0,2})([A-Z])|([0-9]?)([A-Z]{2}))$</code>
    </div>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha384-bmPowDlt+owc6Mn3LwOzLPkYiVm6MuKeLMe0qN2pp7Fhmux2xtVJm5e+ekpCVv4x" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@turf/turf@5.1.6/turf.min.js" integrity="sha384-4AJURQ1iuA3c9I5pNFJ7YBjDqwLDoYhkOeBQlXtGTGGlavq433OFewlaCMV1Cta2" crossorigin="anonymous"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="text/javascript" src="static/flightmap.js"></script>
    <script type="text/javascript" src="static/airspaces_static.js"></script>
    <script type="text/javascript" src="static/upper_lower_airspace_limits.js"></script>
</body>
<script type="text/javascript">
    map.doubleClickZoom.disable();
    var flightStatistics;
    var firUirStatistics;
    var selection = new Set();
    var data = [];
    var names = [];
    var show_percentage = false;

    function plotStatistics() {
        data.length = 0;
        selection.forEach(function(airspace) {
            var firUirData = firUirStatistics[airspace];
            data.push({
                x: firUirData.Dates,
                y: show_percentage ? firUirData.percentage : firUirData.FlightsDetected,
                name: "" + names[airspace] +
                    "<br>(" + airspace + ")",
                type: 'scatter'
            });
        });
        if (selection.size == 0) {
            data.push({
                x: flightStatistics.Dates,
                y: show_percentage ? flightStatistics.percentage : flightStatistics.FlightsDetected,
                name: "the world",
                type: 'scatter'
            })
        }
        var percent_icon = {
            svg: '<svg id="レイヤー_1" data-name="レイヤー 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 325.98 283.46"><defs><style>.cls-1{fill:#231815;}</style></defs><title>%Logo</title><path class="cls-1" d="M330.07,155a72.29,72.29,0,1,0,72.29,72.29A72.29,72.29,0,0,0,330.07,155Zm0,109.14a36.85,36.85,0,1,1,36.85-36.85A36.85,36.85,0,0,1,330.07,264.12Z" transform="translate(-257.79 -154.98)"/><path class="cls-1"    d="M511.49,293.88a72.29,72.29,0,1,0,72.28,72.28A72.28,72.28,0,0,0,511.49,293.88Zm0,109.13a36.85,36.85,0,1,1,36.85-36.85A36.85,36.85,0,0,1,511.49,403Z" transform="translate(-257.79 -154.98)"/><polygon class="cls-1" points="240.61 0 42.12 283.46 85.38 283.46 283.86 0 240.61 0"/></svg>'
        };
        var config = {
            modeBarButtonsToAdd: [{
                    name: show_percentage ? 'show absolute values' : 'show percentages',
                    icon: show_percentage ? Plotly.Icons.pencil : percent_icon,
                    click: function(gd) {
                        show_percentage = !show_percentage;
                        plotStatistics()
                    }
                },
                {
                    name: 'reset selection to world view',
                    icon: Plotly.Icons.undo, //globe_icon,
                    click: function(gd) {
                        selection.clear();
                        plotStatistics()
                    }
                },
            ],
            modeBarButtonsToRemove: ['select2d', 'lasso2d', 'toggleSpikelines',
                'zoomIn2d', 'zoomOut2d', 'resetScale2d'
            ],
            displaylogo: false,
            responsive: true,
            displayModeBar: !L.Browser.mobile
        };
        var layout = {
            margin: {
                t: 30,
                r: 0,
                b: 0,
                l: 0
            },
            title: 'Data from OpenSky Network',
            xaxis: {
                automargin: true,
                title: {
                    text: 'Date (UTC)',
                    standoff: 15
                }
            },
            yaxis: {
                automargin: true,
                title: {
                    text: show_percentage ? 'Airline flights (%)' : 'Airline flights',
                    standoff: 20
                },
                rangemode: 'tozero',
            },
            showlegend: true
        };
        Plotly.react('statistics', data, layout, config);
    }

    function clickAirspace(eo) {
        if (typeof firUirStatistics === 'undefined') {
            console.error('statistical data not available yet.');
            return;
        }
        var feature = eo.target.feature;
        names[feature.properties.AV_AIRSPAC] = feature.properties.AV_NAME;
        if (selection.has(feature.properties.AV_AIRSPAC)) {
            selection.delete(feature.properties.AV_AIRSPAC);
        } else {
            selection.add(feature.properties.AV_AIRSPAC);
        }
        plotStatistics();
    }

    function loadFirUirStatistics() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', './static/fir_uir_statistics.json');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
            if (xhr.status === 200) {
                firUirStatistics = JSON.parse(xhr.responseText);
            }
        };
        xhr.send();
    }

    function loadFlightStatistics() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', './static/flights_statistics.json');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
            if (xhr.status === 200) {
                flightStatistics = JSON.parse(xhr.responseText);
                plotStatistics();
            }
        };
        xhr.send();
    }

    loadFirUirShapes();
    loadFirUirStatistics();
    loadFlightStatistics();
</script>

</html>
